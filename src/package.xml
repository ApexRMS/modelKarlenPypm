<?xml version="1.0" encoding="utf-8"?>
<package name="modelKarlenPypm" displayName="Add-On to the Epidemic Package for the Karlen model" isAddOn="True" extendsPackage="epi" version="1.0.0">
  <transformers>
    <transformer
      name="modelKarlenPypm_fetchSources"
      isPrimary="True"
      displayName="modelKarlenPypm_A_fetchSources"
      programName="python"
      programArguments="fetchModels.py"
      extendsTransformer="epi_Primary"
      isRunnable ="True">
      <datafeeds>
        <datafeed name="ConventionFileOut" displayName="Population Names" dataScope="Scenario">
          <datasheets>
            <datasheet name="ConventionFileOut" displayName="Population Names File" isSingeRow="True">
              <columns>
                <column name="ConventionFileOutID" dataType="Integer" isPrimary="True"/>
                <column name="ScenarioID" dataType="Integer" isOptional="True"/>
                <column name="File" displayName="File" dataType="String" isExternalFile="True"/>
                <column name="DateTime" dataType="String" displayName="Download Date/Time"/>
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>
        <datafeed name="PypmcaJuris" displayName="PypmcaJuris" dataScope="Project">
          <datasheets>
            <datasheet name="PypmcaJuris" valueMember="PypmcaJurisID" displayMember="Name">
              <columns>
                <column name="PypmcaJurisID" dataType="Integer" isPrimary="True"/>
                <column name="ProjectID" dataType="Integer"/>
                <column name="Name" dataType="String"/>
                <column name="URL" dataType="String"/>
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>
        <datafeed name="PypmcaData" displayNAme="PypmcaData" dataScope="Project">
          <datasheets>
            <datasheet name="PypmcaData" valueMember="PypmcaDataID" displayMember="Name">
              <columns>
                <column name="PypmcaDataID" dataType="Integer" isPrimary="True"/>
                <column name="ProjectID" dataType="Integer"/>
                <column name="Name" dataType="String"/>
                <column name="Country" dataType="String"/>
                <column name="Region" dataType="String"/>
                <column name="URL" dataType="String"/>
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>
        <datafeed name="ModelsAvailable" displayName="Models Available" dataScope="Scenario">
          <datasheets>
            <datasheet name="ModelsAvailable" displayname="Models Available">
              <columns>
                <column name="ModelsAvailableID" dataType="Integer" isPrimary="True"/>
                <column name="ScenarioID" dataType="Integer" isOptional="True"/>
                <column name="Country" dataType="String" displayName="Country"/>
                <column name="Region" dataType="String" displayName="Region"/>
                <column name="AgeRange" dataType="String" displayName="Age Range"/>
                <column name="Date" dataType="String" displayName="Date"/>
                <column name="Name" dataType="String" isHidden="True"/>
                <column name="Code" dataType="String" isHidden="True"/>
                <column name="URL" dataType="String" isHidden="True"/>
                <column name="LUT" dataType="String" isHidden="True"/>
              </columns>
              <validations>
                <validation validationType="Unique" columns="Code|Country|Region|Name|URL"/>
              </validations>
            </datasheet>
          </datasheets>
        </datafeed>
      </datafeeds>
      <pipeline>
        <datafeed name="ConventionFileOut" type="Output"/>
        <datafeed name="ModelsAvailable" type="Output"/>
        <datafeed name="PypmcaJuris" type="Output"/>
        <datafeed name="PypmcaData" type="Output"/>
      </pipeline>
      <include>
        <transformer name="modelKarlenPypm_fetchParameters"/>
        <transformer name="modelKarlenPypm_getData"/>
        <transformer name="modelKarlenPypm_runIterations"/>
      </include>
    </transformer>
    <transformer
      name="modelKarlenPypm_fetchParameters"
      displayName="modelKarlenPypm_B_fetchParameters"
      programName="python"
      programArguments="defaultParameters.py"
      extendsTransformer="epi_Primary"
      runContext="LocalOnly"
      isRunnable ="True">
      <datafeeds>
        <datafeed name="ParameterValues" displayName="Parameter Values" dataScope="Scenario">
          <datasheets>
            <datasheet name="ParameterValues" displayname="Parameter Values">
              <columns>
                <column name="ParameterValuesID" dataType="Integer" isPrimary="True"/>
                <column name="ScenarioID" dataType="Integer" isOptional="True"/>
                <column name="Name" dataType="String" displayName="Parameter Name"/>
                <column name="Description" dataType="String" displayName="Description"/>
                <column name="Initial" dataType="Double" displayName="Initial Value"/>
                <column name="Min" dataType="Double" displayName="Minimum Value"/>
                <column name="Max" dataType="Double" displayName="Maximum Value"/>
                <column name="Status" dataType="Integer" validationType="List" formula1="1:fixed|2:variable" displayName="Fixed/Variable"/>
                <column name="PriorDist" dataType="Integer" displayName="Prior Distribution" validationType="List" formula1="1:uniform|2:norm|3:"/>
                <column name="PriorMean" dataType="Double" displayName="Prior Mean"/>
                <column name="PriorSecond" dataType="Double" validationType="Decimal" validationCondition="GreaterEqual" formula1="0.0" displayName="Prior SD/Half-width"/>
                <column name="MCMCStep" dataType="Double" validationType="Decimal" validationCondition="GreaterEqual" formula1="0.0" displayName="MCMC step size"/>
              </columns>
              <validations>
                <validation validationType="Unique" columns="Name|Description"/>
              </validations>
            </datasheet>
          </datasheets>
        </datafeed>
        <datafeed name="ModelFile" displayName="Downloaded Model" dataScope="Scenario">
          <datasheets>
            <datasheet name="ModelFile" displayName="Downloaded Model" isSingeRow="True">
              <columns>
                <column name="ModelFileID" dataType="Integer" isPrimary="True"/>
                <column name="ScenarioID" dataType="Integer" isOptional="True"/>
                <column name="Region" dataType="String" displayName="Region"/>
                <column name="Name" dataType="String" displayName="Name"/>
                <column name="URL" dataType="String" displayName="URL"/>
                <column name="PypmFile" displayName="Object File" dataType="String" isExternalFile="True"/>
                <column name="DateTime" dataType="String" displayName="Download Date/Time"/>
              </columns>
              <validations>
                <validation validationType="Unique" columns="Region|Name|URL|PypmFile"/>
              </validations>
            </datasheet>
          </datasheets>
        </datafeed>
        <datafeed name="PopulationSelectionTable" displayName="Population Selection" dataScope="Scenario">
          <datasheets>
            <datasheet name="PopulationSelectionTable" displayName="Population Selection">
              <columns>
                <column name="PopulationSelectionTableID" dataType="Integer" isPrimary="True"/>
                <column name="ScenarioID" dataType="Integer" isOptional="True"/>
                <column name="Show" dataType="Boolean" displayName="Show (Yes/No)"/>
                <column name="Standard" dataType="String" displayName="Population Name"/>
                <column name="Description" dataType="String"/>
                <column name="Stock" dataType="String"/>
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>
        <datafeed name="ModelChoices" displayName="Model Options" dataScope="Scenario">
          <datasheets>
            <datasheet name="ModelChoices" displayName="Model Options">
              <columns>
                <column name="ModelChoiceID" dataType="Integer" isPrimary="True"/>
                <column name="ScenarioID" dataType="Integer"/>
                <column name="Location" dataType="Integer" validationType="Datasheet" formula1="PypmcaJuris" allowDbNull="False" displayname="Model:"/>
                <column name="FileName" dataType="String" displayName="Crosswalk File:" isExternalFile="True"/>
              </columns>
              <defaultRecords>
                <record columns="FileName" values="C:\Users\User\Documents\GitHub\modelKarlenPypm\StockToStandard.csv"/>
              </defaultRecords>
            </datasheet>
          </datasheets>
        </datafeed>
      </datafeeds>
      <pipeline>
        <datafeed name="ParameterValues" type="Output"/>
        <datafeed name="ModelFile" type="Output"/>
        <datafeed name="PopulationSelectionTable" type="Output"/>
        <datafeed name="ModelChoices" type="Input"/>
      </pipeline>
    </transformer>
    <transformer
      name="modelKarlenPypm_getData"
      displayName="modelKarlenPypm_C_getData"
      programName="python"
      programArguments="getData.py"
      extendsTransformer="epi_Primary"
      runContext="LocalOnly"
      isRunnable ="True">
      <datafeeds>
        <datafeed name="DataChoices" displayName="Data Options" dataScope="Scenario">
          <datasheets>
            <datasheet name="DataChoices" displayName="Data Options">
              <columns>
                <column name="ModelChoiceID" dataType="Integer" isPrimary="True"/>
                <column name="ScenarioID" dataType="Integer"/>
                <column name="DataSet" dataType="Integer" validationType="Datasheet" formula1="PypmcaData" allowDbNull="False" displayName="Data Set:"/>
                <column name="FileName" dataType="String" displayName="Crosswalk File:" isExternalFile="True"/>
              </columns>
              <defaultRecords>
                <record columns="FileName" values="C:\Users\User\Documents\GitHub\modelKarlenPypm\StockToStandard.csv"/>
              </defaultRecords>
            </datasheet>
          </datasheets>
        </datafeed>
        <datafeed name="DataFileOut" displayName="Data File" dataScope="Scenario">
          <datasheets>
            <datasheet name="DataFileOut" displayName="Data File" isSingeRow="True">
              <columns>
                <column name="DataFileOutID" dataType="Integer" isPrimary="True"/>
                <column name="ScenarioID" dataType="Integer" isOptional="True"/>
                <column name="File" displayName="File" dataType="String" isExternalFile="True"/>
                <column name="DateTime" dataType="String" displayName="Download Date/Time"/>
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>
      </datafeeds>
      <pipeline>
        <datafeed name="DataChoices" type="Input"/>
        <datafeed name="epi_DataSummary" type="Output"/>
        <datafeed name="DataFileOut" type="Output"/>
        <datafeed name="ConventionFileOut" type="Input"/>
      </pipeline>
    </transformer>
    <transformer
      name="modelKarlenPypm_runIterations"
      displayName="modelKarlenPypm_D_runIterations"
      programName="python"
      programArguments="runIterations.py"
      extendsTransformer="epi_Primary"
      runContext="LocalOnly"
      isRunnable ="True">
      <datafeeds>
        <datafeed name="FittingParams" displayName="Fitting Parameters" dataScope="Scenario">
          <datasheets>
            <datasheet name="FittingParams" displayName="Fitting Parameters" isSingleRow="True">
              <columns>
                <column name="FittingParamsID" dataType="Integer" isPrimary="True"/>
                <column name="ScenarioID" dataType="Integer" isOptional="True"/>
                <column name="FitVariable" dataType="Integer" validationType="List" formula1="1:Cases - Cumulative|2:Reported - Cumulative|3:Cases - Daily|4: Reported - Daily" displayName="Variable To Fit:"/>
                <column name="StartFit" dataType="Integer" validationType="WholeNumber" validationCondition="Greater" formula1="0" displayName="Day To Start Fitting:"/>
                <column name="EndFit" dataType="Integer" validationType="WholeNumber" validationCondition="Greater" formula1="0" displayName="Day To End Fitting:"/>
                <column name="CumulReset" dataType="Boolean" displayName="Reset Cumulative to Zero:"/>
                <column name="SkipDatesText" dataType="String" displayName="Days to Skip:"/>
                <column name="Iterations" dataType="Integer"/>
                <column name="EndDate" dataType="Date" displayName="End Date"/>
              </columns>
              <defaultRecords>
                <record columns="FitVariable|StartFit|SkipDatesText|Iterations|EndDate" values="1|37|147,45:47|2|2021-05-15"/>
              </defaultRecords>
            </datasheet>
          </datasheets>
        </datafeed>
        <datafeed name="FitVariables" displayName="Fit Variables" dataScope="Scenario">
          <datasheets>
            <datasheet name="FitVariables" displayName="Fit Variables">
              <columns>
                <column name="FitVariablesID" dataType="Integer" isPrimary="True"/>
                <column name="ScenarioID" dataType="Integer"/>
                <column name="Variable" dataType="String"/>
                <column name="Value" dataType="Double"/>
              </columns>
            </datasheet>
          </datasheets>
        </datafeed>
      </datafeeds>
      <pipeline>
        <datafeed name="ParameterValues" type="Input"/>
        <datafeed name="ModelFile" type="Input"/>
        <datafeed name="PopulationSelectionTable" type="Input"/>
        <datafeed name="ConventionFileOut" type="Input"/>
        <datafeed name="FittingParams" type="Input"/>
        <datafeed name="ModelChoices" type="Input"/>
        <datafeed name="epi_DataSummary" type="Both"/>
      </pipeline>
    </transformer>
  </transformers>
  <layouts>
    <layout name="coreforms_ScenarioDatafeeds">
      <group name="KarlenModel" displayName="pypmca" appendTo="epi_Models">
        <group name="Inputs" displayName="Inputs" appendTo="KarlenModel">
          <item name="ModelChoices"/>
          <item name="FittingParams"/>
          <item name="ParameterValues"/>
          <item name="ModelFile"/>
          <item name="PopulationSelectionTable"/>
          <item name="DataChoices"/>
        </group>
        <group name="Outputs" displayName="Outputs" appendTo="KarlenModel">
          <item name="ModelsAvailable"/>
          <item name="ConventionFileOut"/>
          <item name="FitVariables"/>
          <item name="DataFileOut"/>
          <item name="epi_DataSummary" filterTransformer="modelKarlenPypm_runIterations"/>
        </group>
      </group>
    </layout>
  </layouts>
</package>
